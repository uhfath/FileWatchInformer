### Установка

Необходимо скачать соответствующий архив:
* `portable_x64` - версия под `Windows x64` без внешних зависимостей (самая объёмная);
* `dotnet_x64` - версия для предустановленного [.NET 7](https://dotnet.microsoft.com/en-us/download/dotnet/7.0) под `Windows x64` (объём меньше).

> Для установки .NET 7 необходимо скачать пакет любой версии 7.* `Runtime`.

После скачивания архива, его необходимо распаковать в любое место и заполнить файл `config.json` нужными параметрами.
Запуск можно осуществлять двумя способами:
* `console.bat` запускает сервис в режиме консоли с большей детализацией логгирования (удобно для отладки)
* `install.bat` регистрирует службу в системе

Службу так же можно контролировать с помощью скриптов `start.bat` и `stop.bat`.
Для удаления службы из системы используется скрипт `uninstall.bat`.

### Отладка

При установке сервиса в качестве службы Windows все сообщения об ошибках попадают в Event Log под категорией "Приложения" с именем источника `FileWatchInformer`.

При использовании в режиме приложения (запуск через `console.bat`) все сообщения выводятся в консоль.

### Конфигурирование

Все параметры можно задать как в файле `config.json` (должен находиться в пределах поиска рабочей папки сервиса), так и в переменных окружения и командной строке.
Приоритет такой `config.json` -> `переменные окружения` -> `командная строка`.
Таким образом параметры из командной строки переопределяют переменные окружения, которые переопределяют `config.json`.

##### Формат используя переменные окружения такой:
`FWI_`*категория*`__`*имя*`=`*"значение"*

Например, `FWI_Email__Server="test.ru"` задёт значение параметра `Server` в категории `Email` равным `test.ru`

##### Формат используя командную строку такой:
*категория*`:`*имя*`=`*"значение"*

Например, `Email:Server="test.ru"` задёт значение параметра `Server` в категории `Email` равным `test.ru`

##### Отличие между переменными окружения и командной строкой:
* у переменных окружения используется префикс `FWI_` и символ двойного подчёркивания (`__`) как разделитель
* у командной строки нет префикса, а для разделителя используется символ двоеточия (`:`)

#### `Email`

> *поля со звёздочкой обязательные*

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| **`Server`** * | Адрес SMTP сервера. |  |
| `Port` | Номер используемого SMTP порта. | 587 |
| `Security` | Настройка шифрования: <ul><li>`Auto` - автоматический режим определения;</li><li>`None` - не использовать SSL/TLS шифрование;</li><li>`SslOnConnect` - использовать SSL/TLS;</li><li>`StartTls` - использовать только TLS. Если сервер не поддерживает `STARTTLS`, будет ошибка;</li><li>`StartTlsWhenAvailable` - использовать TLS, только если сервер поддерживает `STARTTLS`.</li></ul> | `Auto` |
| **`Login`** * | Имя пользователя для подключения к SMTP. |  |
| **`Password`** * | Пароль для подключения к SMTP. |  |
| **`From`** * | Поле "от кого" в создаваемом сообщении. |  |
| `ValidateCertificate` | Проверять ли валидность сертификата почтового сервера или нет: <ul><li>`true` - проверять</li><li>`false` - не проверять</li></ul> | `true` |
| `DefaultSubject` | Тема сообщения по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. | Информирование о наличии невостребованных файлов |
| `DefaultBody` | Текст сообщения по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. | <p>Уважаемый, %USERNAME%!</p><hr/><p>Вот список файлов, которые необходимо обработать:</p><ul>%FILELIST%</ul> |

#### `Watcher`

> *поля со звёздочкой обязательные*

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| **`Folder`** * | Путь к папке мониторинга. |  |
| `Interval` | Интервал проверки папки `Folder`. Формат `hh:mm:ss`, где `hh` - часы, `mm` - минуты, `ss` - секунды. |  |
| `Delay` | Задержка между отправкой сообщений. Формат `hh:mm:ss`, где `hh` - часы, `mm` - минуты, `ss` - секунды. |  |
| `DefaultIncludePattern` | **Регулярное выражение** для _отбора_ файлов по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. |  |
| `DefaultExcludePattern` | **Регулярное выражение** для _исключения_ файлов по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. |  |
| `DefaultIncludeWildcard` | **Маска** для _отбора_ файлов по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. |  |
| `DefaultExcludeWildcard` | **Маска** для _исключения_ файлов по умолчанию, если не переопределено в индивидуальных параметрах каждого пользователя. |  |

Если `Interval` установлен, то через указанные интервалы будет проводиться проверка содержимого папки `Folder`.
Допускается задание только либо `Default***Pattern` либо `Default***Wildcard`. Нельзя задавать оба типа отбора одновременно.

Если внутри будут обнаружены файлы, исключённые по одним критериям (`DefaultExcludePattern`/`User`.`ExcludePattern` либо `DefaultExcludeWildcard`/`User`.`ExcludeWildcard`) и подходящие по другим (`DefaultIncludePattern`/`User`.`IncludePattern` либо `DefaultIncludeWildcard`/`User`.`IncludeWildcard`), то в соответствии с именем корневой папки из `Users` будет получен адресат (`User`.`Address`), которого необходимо проинформировать с темой (`DefaultSubject`/`User`.`Subject`) и текстом (`DefaultBody`/`User`.`Body`).
Приоритет поиска отдаётся исключениям. Другими словами, если файл был исключён критерием (`DefaultExcludePattern`/`User`.`ExcludePattern` либо `DefaultExcludeWildcard`/`User`.`ExcludeWildcard`), то дальше он уже не попадёт.

Если `Interval` не задан, то проверка будет произведена один раз при запуске сервиса, а затем сервис будет остановлен. Удобно в случае, если нужно контролировать интервалы внешними средствами (например, планировщик вашей ОС).

Если `Delay` установлен, то указанная задержка будет использоваться между отправкой каждого сообщения пользователю. Удобно в случае, если почтовый сервер не допускает слишком частой отправки писем.

#### `Users`

> *поля со звёздочкой обязательные*

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `Name` | Имя пользователя. Используется для составления шаблона письма. |  |
| **`Folder`** * | Имя подпапки внутри `Watcher`.`Folder` (на первом уровне). |  |
| **`Address`** * | Адрес электронной почты, на который необходимо посылать уведомление. |  |
| `Subject` | Тема сообщения. Можно указывать индивидуально для каждого пользователя. Если не установлено, используется `Email`.`DefaultSubject`. |  |
| `Body` | Текст сообщения. Можно указывать индивидуально для каждого пользователя. Если не установлено, используется `Email`.`DefaultBody`. |  |
| `IncludePattern` | **Регулярное выражение** для _отбора_ файлов. Если не установлено, используется `Watcher`.`DefaultIncludePattern` |  |
| `ExcludePattern` | **Регулярное выражение** для _исключения_ файлов. Если не установлено, используется `Watcher`.`DefaultExcludeWildcard` |  |
| `IncludeWildcard` | **Маска** для _отбора_ файлов. Если не установлено, используется `Watcher`.`DefaultIncludeWildcard` |  |
| `ExcludeWildcard` | **Маска** для _исключения_ файлов. Если не установлено, используется `Watcher`.`DefaultExcludeWildcard` |  |


Допускается задание только либо `***Pattern` либо `***Wildcard`. Нельзя задавать оба типа отбора одновременно.

#### Макросы для текста сообщения

Можно использовать следующие макросы для подстановки в текст сообщения:
* `%USERNAME%` - заменяется на имя пользователя (параметр `User`.`Name`).
* `%FILELIST%` - заменяется на список файлов, обнаруженных сервисом для конкретного пользователя.
